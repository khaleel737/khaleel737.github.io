<!doctype html><html lang=en><head><script defer src=https://analytics.eu.umami.is/script.js data-website-id=ff740bb2-f741-4bc5-975e-49691d82ef39></script><meta charset=utf-8><meta name=generator content="Hugo 0.148.2"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://maxhalford.github.io/blog/bike-sharing-forecasting-training-set/"><link rel=canonical href=https://maxhalford.github.io/blog/bike-sharing-forecasting-training-set/><meta property="og:url" content="https://maxhalford.github.io/blog/bike-sharing-forecasting-training-set/"><meta property="og:site_name" content="Max Halford"><meta property="og:title" content="A training set for bike sharing forecasting"><meta property="og:description" content="Last night I went to a Toulouse Data Science meetup. The talks were about generative AI and information retrieval, which aren’t topics I’m knowledgeable about. However, one of the speakers was a friend of mine, so I went to support him. Toulouse is my hometown, so I bumped into a few people I knew. It was a nice evening."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-04-04T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-04T00:00:00+00:00"><meta property="article:tag" content="Data-Eng"><meta property="article:tag" content="Machine-Learning"><meta property="og:image" content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:title content="A training set for bike sharing forecasting"><meta name=twitter:description content="Last night I went to a Toulouse Data Science meetup. The talks were about generative AI and information retrieval, which aren’t topics I’m knowledgeable about. However, one of the speakers was a friend of mine, so I went to support him. Toulouse is my hometown, so I bumped into a few people I knew. It was a nice evening."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🦔</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"A training set for bike sharing forecasting","headline":"A training set for bike sharing forecasting","description":"\u003cstyle\u003e\ntable {\n  font-family: monospace; \/* Apply monospace font *\/\n}\n\ntable td, table th {\n  white-space: nowrap; \/* Prevent text from wrapping *\/\n}\n\u003c\/style\u003e\n\u003cp\u003eLast night I went to a \u003ca href=\u0022https:\/\/www.meetup.com\/fr-FR\/tlse-data-science\/\u0022\u003eToulouse Data Science\u003c\/a\u003e meetup. The talks were about generative AI and information retrieval, which aren\u0026rsquo;t topics I\u0026rsquo;m knowledgeable about. However, one of the speakers was a \u003ca href=\u0022https:\/\/github.com\/raphaelsty\u0022\u003efriend\u003c\/a\u003e of mine, so I went to support him. Toulouse is my hometown, so I bumped into a few people I knew. It was a nice evening.\u003c\/p\u003e","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2024","datePublished":"2024-04-04 00:00:00 \u002b0000 UTC","dateModified":"2024-04-04 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/bike-sharing-forecasting-training-set\/","keywords":["data-eng","machine-learning"]}</script><title>A training set for bike sharing forecasting • Max Halford</title><meta property="og:title" content="A training set for bike sharing forecasting • Max Halford"><meta property="og:type" content="article"><meta name=description content="
Last night I went to a Toulouse Data Science meetup. The talks were about generative AI and information retrieval, which aren&rsquo;t topics I&rsquo;m knowledgeable about. However, one of the speakers was a friend of mine, so I went to support him. Toulouse is my hometown, so I bumped into a few people I knew. It was a nice evening."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src=https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ツ</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>A training set for bike sharing forecasting</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=posts-line-date datetime="2024-04-04 00:00:00 UTC">2024-04-04
</time><span class=posts-line-tag>data-eng</span>
<span class=posts-line-tag>machine-learning</span></div></div></header><div class="post-content markdown-body"><style>table{font-family:monospace}table td,table th{white-space:nowrap}</style><p>Last night I went to a <a href=https://www.meetup.com/fr-FR/tlse-data-science/>Toulouse Data Science</a> meetup. The talks were about generative AI and information retrieval, which aren&rsquo;t topics I&rsquo;m knowledgeable about. However, one of the speakers was a <a href=https://github.com/raphaelsty>friend</a> of mine, so I went to support him. Toulouse is my hometown, so I bumped into a few people I knew. It was a nice evening.</p><p>I chatted with an old office <a href="https://scholar.google.com/citations?user=eoxrO3MAAAAJ&amp;hl=en">mate</a> from when I interned at INSA Toulouse. He initially encouraged me to work on <a href="https://www.youtube.com/watch?v=vQGdzKkyPP0">OpenBikes</a>, which was a project to scrape bike sharing data in order to train a forecasting model. It never really made it into production. However, the project taught me a lot about machine learning and software engineering, and <a href=https://actu.fr/occitanie/toulouse_31555/dataconnexions-openbikes-recoit-le-prix-special-open-data-toulouse-metropole_3632308.html>opened</a> a few doors. I&rsquo;m grateful for his advice at the time. I shut down the OpenBikes project when I started my PhD, due to a lack of time.</p><p>Last summer, I motivated myself to resurrect the scraping part of this project. I used Simon Willison&rsquo;s <a href=https://simonwillison.net/2020/Oct/9/git-scraping/>git scraping</a> technique. This enabled me to write a <a href=https://github.com/MaxHalford/bike-sharing-history>GitHub Action</a> that manages to scrape data for >50 cities, in ~25 seconds, every 15 minutes.</p><p>Last night&rsquo;s discussion has motivated me to put extra energy into this project. My friend is offering to put a model into production, if I provide him with a training set. Our (ambitious) plan is to build a model that could be helpful for the upcoming Olympic Games in Paris. I&rsquo;m not sure if we&rsquo;ll make it, but it&rsquo;s a fun project to work on.</p><p>Anyway, enough about me and my life. I&rsquo;m going to share some code to retrieve the data I&rsquo;m scraping, and turn it into a training set for a forecasting model.</p><p>I&rsquo;m storing the data in a Google Cloud Storage <a href="https://console.cloud.google.com/storage/browser/bike-sharing-history;tab=objects?forceOnBucketsSortingFiltering=true&amp;authuser=1&amp;project=bike-sharing-407017&amp;prefix=&amp;forceOnObjectsSortingFiltering=false">bucket</a>. There&rsquo;s one Parquet file for each city/provider/month. The data for a given month is archived once the month is over. A nifty way to access the data is via <a href=https://duckdb.org/>DuckDB</a>, which provides a SQL interface to <a href="https://www.databricks.com/glossary/what-is-parquet#:~:text=What%20is%20Parquet%3F,handle%20complex%20data%20in%20bulk.">Parquet</a> files. Here&rsquo;s how to retrieve the data for Toulouse:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>duckdb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>duckdb</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;:memory:&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>con</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>con</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SET s3_endpoint=&#39;storage.googleapis.com&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>updates</span> <span class=o>=</span> <span class=n>con</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    SELECT *
</span></span></span><span class=line><span class=cl><span class=s2>    FROM READ_PARQUET(&#39;s3://bike-sharing-history/toulouse/jcdecaux/*/*.parquet&#39;);
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>fetch_df</span><span class=p>()</span>  <span class=c1># this is a pandas DataFrame</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>updates</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;station == &#39;00003 - POMME&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>to_markdown</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>station</th><th style=text-align:right>longitude</th><th style=text-align:right>latitude</th><th style=text-align:left>commit_at</th><th style=text-align:right>skipped_updates</th><th style=text-align:right>bikes</th><th style=text-align:right>stands</th></tr></thead><tbody><tr><td style=text-align:left>00003 - POMME</td><td style=text-align:right>1.44545</td><td style=text-align:right>43.6033</td><td style=text-align:left>2023-08-05 12:00:02</td><td style=text-align:right>0</td><td style=text-align:right>14</td><td style=text-align:right>4</td></tr><tr><td style=text-align:left>00003 - POMME</td><td style=text-align:right>1.44545</td><td style=text-align:right>43.6033</td><td style=text-align:left>2023-08-05 12:56:53</td><td style=text-align:right>10</td><td style=text-align:right>17</td><td style=text-align:right>1</td></tr><tr><td style=text-align:left>00003 - POMME</td><td style=text-align:right>1.44545</td><td style=text-align:right>43.6033</td><td style=text-align:left>2023-08-05 13:19:12</td><td style=text-align:right>0</td><td style=text-align:right>14</td><td style=text-align:right>4</td></tr><tr><td style=text-align:left>00003 - POMME</td><td style=text-align:right>1.44545</td><td style=text-align:right>43.6033</td><td style=text-align:left>2023-08-05 13:31:18</td><td style=text-align:right>0</td><td style=text-align:right>12</td><td style=text-align:right>6</td></tr><tr><td style=text-align:left>00003 - POMME</td><td style=text-align:right>1.44545</td><td style=text-align:right>43.6033</td><td style=text-align:left>2023-08-05 13:33:18</td><td style=text-align:right>0</td><td style=text-align:right>14</td><td style=text-align:right>4</td></tr></tbody></table><p>The GitHub Action scrapes the API of each bike sharing system every 15 minutes. There is no need to record the current state if nothing changed at a given bike station. The <code>skipped_updates</code> column indicates how many updates were skipped. This is a form of logical compression which saves a lot of disk space. The <code>commit_at</code> column indicates when the data was recorded. The <code>bikes</code> and <code>stands</code> columns indicate the number of bikes and stands at the station. The <code>longitude</code> and <code>latitude</code> columns indicate the geographical location of the station.</p><p>The above format can be turned into a full history by inferring each bike station&rsquo;s state at given points in time. There is no deterministic to know the exact state of a bike station at a given point in time. Indeed, the number of bikes/stands might fluctuate between the different moments when the data is scrapped. However, we can make an educated guess by looking at the last known state of the station. Here&rsquo;s an example:</p><div align=center><figure style=width:90%;margin:0><img src=/img/blog/bike-sharing-forecasting-training-set/uncompress.png style=box-shadow:none></figure></div></br><p>The idea to define a 15 minutes schedule, and to fill the gaps with the last known state of the station. Here&rsquo;s how to do it with <a href=https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.resample.html>pandas&rsquo; <code>resample</code> method</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>history</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>updates</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;station&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>resample</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>rule</span><span class=o>=</span><span class=s1>&#39;15min&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>on</span><span class=o>=</span><span class=s1>&#39;commit_at&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=s1>&#39;station&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;station&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;station&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>ffill</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>subset</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;skipped_updates&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>[[</span><span class=s1>&#39;bikes&#39;</span><span class=p>,</span> <span class=s1>&#39;stands&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>&#39;uint8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>history</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;station == &#39;00003 - POMME&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>to_markdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>time</th><th style=text-align:right>bikes</th><th style=text-align:right>stands</th></tr></thead><tbody><tr><td style=text-align:left>2023-08-05 12:15:00</td><td style=text-align:right>14</td><td style=text-align:right>4</td></tr><tr><td style=text-align:left>2023-08-05 12:30:00</td><td style=text-align:right>14</td><td style=text-align:right>4</td></tr><tr><td style=text-align:left>2023-08-05 12:45:00</td><td style=text-align:right>14</td><td style=text-align:right>4</td></tr><tr><td style=text-align:left>2023-08-05 13:00:00</td><td style=text-align:right>17</td><td style=text-align:right>1</td></tr><tr><td style=text-align:left>2023-08-05 13:15:00</td><td style=text-align:right>17</td><td style=text-align:right>1</td></tr></tbody></table><p>I want to emphasize this is just one way of doing it. Indeed, the exact state of a station at any given time is not known to us, so it has to be inferred. The above solution is not perfect, but it&rsquo;s a start, and it&rsquo;s definitely sufficient for training a forecasting model. A simple solution would be to increase the frequency at which the data is scrapped, but I don&rsquo;t have the budget for that.</p><p>For this problem, a useful model would be able to predict the amount of bikes in a station over the next 120 minutes, at 15 minutes intervals. Here&rsquo;s how to create these targets:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>bikes_ahead</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>history</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;station&#39;</span><span class=p>)[</span><span class=s1>&#39;bikes&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>([</span><span class=o>-</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>9</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>&#39;uint8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bikes_ahead</span><span class=o>.</span><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;bikes_+</span><span class=si>{</span><span class=mi>15</span> <span class=o>*</span> <span class=n>i</span><span class=si>}</span><span class=s1>min&#39;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>9</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>bikes_ahead</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;station == &#39;00003 - POMME&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>to_markdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left></th><th style=text-align:right>bikes_+15min</th><th style=text-align:right>bikes_+30min</th><th style=text-align:right>bikes_+45min</th><th style=text-align:right>bikes_+60min</th><th style=text-align:right>bikes_+75min</th><th style=text-align:right>bikes_+90min</th><th style=text-align:right>bikes_+105min</th><th style=text-align:right>bikes_+120min</th></tr></thead><tbody><tr><td style=text-align:left>2023-08-05 12:15:00</td><td style=text-align:right>14</td><td style=text-align:right>14</td><td style=text-align:right>17</td><td style=text-align:right>17</td><td style=text-align:right>14</td><td style=text-align:right>14</td><td style=text-align:right>18</td><td style=text-align:right>18</td></tr><tr><td style=text-align:left>2023-08-05 12:30:00</td><td style=text-align:right>14</td><td style=text-align:right>17</td><td style=text-align:right>17</td><td style=text-align:right>14</td><td style=text-align:right>14</td><td style=text-align:right>18</td><td style=text-align:right>18</td><td style=text-align:right>18</td></tr><tr><td style=text-align:left>2023-08-05 12:45:00</td><td style=text-align:right>17</td><td style=text-align:right>17</td><td style=text-align:right>14</td><td style=text-align:right>14</td><td style=text-align:right>18</td><td style=text-align:right>18</td><td style=text-align:right>18</td><td style=text-align:right>16</td></tr><tr><td style=text-align:left>2023-08-05 13:00:00</td><td style=text-align:right>17</td><td style=text-align:right>14</td><td style=text-align:right>14</td><td style=text-align:right>18</td><td style=text-align:right>18</td><td style=text-align:right>18</td><td style=text-align:right>16</td><td style=text-align:right>15</td></tr><tr><td style=text-align:left>2023-08-05 13:15:00</td><td style=text-align:right>14</td><td style=text-align:right>14</td><td style=text-align:right>18</td><td style=text-align:right>18</td><td style=text-align:right>18</td><td style=text-align:right>16</td><td style=text-align:right>15</td><td style=text-align:right>18</td></tr></tbody></table><p>The above DataFrame can be used to train a forecasting model. Here&rsquo;s an example using a <a href=https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.HistGradientBoostingRegressor.html>HistGradientBoostingRegressor</a> from scikit-learn, which is their LightGBM-like implementation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn</span> <span class=kn>import</span> <span class=n>ensemble</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn</span> <span class=kn>import</span> <span class=n>model_selection</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ensemble</span><span class=o>.</span><span class=n>HistGradientBoostingRegressor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span><span class=o>=</span><span class=s1>&#39;poisson&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>features</span> <span class=o>=</span> <span class=n>history</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>bikes_ahead</span><span class=o>.</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cv</span> <span class=o>=</span> <span class=n>model_selection</span><span class=o>.</span><span class=n>GroupKFold</span><span class=p>(</span><span class=n>n_splits</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>groups</span> <span class=o>=</span> <span class=n>bikes_ahead</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>get_level_values</span><span class=p>(</span><span class=s1>&#39;station&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>target_col</span> <span class=ow>in</span> <span class=n>bikes_ahead</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>scores</span> <span class=o>=</span> <span class=n>model_selection</span><span class=o>.</span><span class=n>cross_val_score</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>features</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bikes_ahead</span><span class=p>[</span><span class=n>target_col</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>groups</span><span class=o>=</span><span class=n>groups</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>=</span><span class=n>cv</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>scoring</span><span class=o>=</span><span class=s1>&#39;neg_mean_squared_error&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>target_col</span><span class=si>}</span><span class=s1> — </span><span class=si>{</span><span class=o>-</span><span class=n>scores</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1> ± </span><span class=si>{</span><span class=n>scores</span><span class=o>.</span><span class=n>std</span><span class=p>()</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><pre tabindex=0><code>bikes_+15min  — 1.09 ± 0.05
bikes_+30min  — 2.24 ± 0.11
bikes_+45min  — 3.41 ± 0.17
bikes_+60min  — 4.57 ± 0.23
bikes_+75min  — 5.74 ± 0.29
bikes_+90min  — 6.89 ± 0.34
bikes_+105min — 8.03 ± 0.39
bikes_+120min — 9.14 ± 0.43
</code></pre><p>These figures provide a baseline. The model is not very good, but there is room for improvement. We could add some time-based features. We could also leverage the geographical layout of the stations. Moreover, the regression task could be framed differently. For instance, we could predict the number of bikes that will be taken/added, instead of directly predicting the number of bikes. This could be an easier task for the model.</p><p>In addition to bike sharing data, I&rsquo;ve collected weather data from <a href=https://open-meteo.com/>Open-Meteo</a>. Instead of just storing the current weather, I&rsquo;ve stored short-term forecasts, relative to the moment when the data is scrapped. This data could be used to improve the model. For instance, the model could learn that people are less likely to take a bike if it&rsquo;s likely to rain in 30 minutes. The weather data is stored similarly to the bike sharing data. Here&rsquo;s how to retrieve it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>with</span> <span class=n>duckdb</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;:memory:&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>con</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>con</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SET s3_endpoint=&#39;storage.googleapis.com&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>weather</span> <span class=o>=</span> <span class=n>con</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    SELECT *
</span></span></span><span class=line><span class=cl><span class=s2>    FROM READ_PARQUET(&#39;s3://weather-forecast-history/toulouse/*/*.parquet&#39;);
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>fetch_df</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>weather</span><span class=o>.</span><span class=n>head</span><span class=p>()</span><span class=o>.</span><span class=n>to_markdown</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>commit_at</th><th style=text-align:left>forecast_at</th><th style=text-align:right>temperature</th><th style=text-align:right>rain</th><th style=text-align:right>wind_speed</th></tr></thead><tbody><tr><td style=text-align:left>2023-08-01 01:44:46</td><td style=text-align:left>2023-08-01T00:00</td><td style=text-align:right>19.5</td><td style=text-align:right>0</td><td style=text-align:right>10.3</td></tr><tr><td style=text-align:left>2023-08-01 01:44:46</td><td style=text-align:left>2023-08-01T01:00</td><td style=text-align:right>18.3</td><td style=text-align:right>0</td><td style=text-align:right>8.3</td></tr><tr><td style=text-align:left>2023-08-01 01:44:46</td><td style=text-align:left>2023-08-01T02:00</td><td style=text-align:right>17.9</td><td style=text-align:right>0</td><td style=text-align:right>6.6</td></tr><tr><td style=text-align:left>2023-08-01 01:44:46</td><td style=text-align:left>2023-08-01T03:00</td><td style=text-align:right>17.8</td><td style=text-align:right>0</td><td style=text-align:right>5.5</td></tr><tr><td style=text-align:left>2023-08-01 01:44:46</td><td style=text-align:left>2023-08-01T04:00</td><td style=text-align:right>17.3</td><td style=text-align:right>0</td><td style=text-align:right>5.7</td></tr></tbody></table><p>Using weather data can be tricky, though, because in production you&rsquo;ll have to retrieve the weather forecast in order to make a prediction. It&rsquo;s straightforward, but it&rsquo;s an extra step that has to be justified.</p><p>That&rsquo;s it, I hope this can be useful to some people. As for our objective of building a model for the Olympic Games, it turns out that the Paris API was updated last fall! There is a <a href=https://www.velib-metropole.fr/donnees-open-data-gbfs-du-service-velib-metropole>new endpoint</a>, which I shall start scraping right away 🏃‍♂️</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>
Back to the top</div></div><div class=subscribe><a href=http://eepurl.com/iRBqMg>Subscribe</a></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style="margin-top:10px !important;margin-bottom:10px !important">Related posts</h3><ul style=margin-top:0><li><a href=/blog/skyline-queries/>Skyline queries in Python</a></li><li><a href=/blog/dataset-time-travel/>An overview of dataset time travel</a></li><li><a href=/blog/target-encoding/>Target encoding done the right way</a></li></ul></div></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll("img"));images.forEach(e=>{mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null})})</script></body></html>