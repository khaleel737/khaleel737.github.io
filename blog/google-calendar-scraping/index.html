<!doctype html><html lang=en><head><script defer src=https://analytics.eu.umami.is/script.js data-website-id=ff740bb2-f741-4bc5-975e-49691d82ef39></script><meta charset=utf-8><meta name=generator content="Hugo 0.151.0"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://maxhalford.github.io/blog/google-calendar-scraping/"><link rel=canonical href=https://maxhalford.github.io/blog/google-calendar-scraping/><meta property="og:url" content="https://maxhalford.github.io/blog/google-calendar-scraping/"><meta property="og:site_name" content="Max Halford"><meta property="og:title" content="Scraping Google Calendar events"><meta property="og:description" content="At my day job we deal with enterprise customers. They pay us a subscription fee, and in return we help them in various ways to reduce their carbon footprint. To keep the boat afloat, we need to make some money. We shouldnâ€™t spend more money than we make. So we need to keep track of our revenue and costs. Our gross margin is (revenue - cost) / revenue, where the cost is mostly the salaries of our employees."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-10-12T00:00:00+00:00"><meta property="article:modified_time" content="2025-10-12T00:00:00+00:00"><meta property="article:tag" content="Python"><meta property="article:tag" content="Scraping"><meta property="og:image" content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:title content="Scraping Google Calendar events"><meta name=twitter:description content="At my day job we deal with enterprise customers. They pay us a subscription fee, and in return we help them in various ways to reduce their carbon footprint. To keep the boat afloat, we need to make some money. We shouldnâ€™t spend more money than we make. So we need to keep track of our revenue and costs. Our gross margin is (revenue - cost) / revenue, where the cost is mostly the salaries of our employees."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦”</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"Scraping Google Calendar events","headline":"Scraping Google Calendar events","description":"\u003cp\u003eAt my day job we deal with enterprise customers. They pay us a subscription fee, and in return we help them in various ways to reduce their carbon footprint. To keep the boat afloat, we need to make some money. We shouldn\u0026rsquo;t spend more money than we make. So we need to keep track of our revenue and costs. Our gross margin is \u003ccode\u003e(revenue - cost) \/ revenue\u003c\/code\u003e, where the cost is mostly the salaries of our employees.\u003c\/p\u003e","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2025","datePublished":"2025-10-12 00:00:00 \u002b0000 UTC","dateModified":"2025-10-12 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/google-calendar-scraping\/","keywords":["python","scraping"]}</script><title>Scraping Google Calendar events â€¢ Max Halford</title><meta property="og:title" content="Scraping Google Calendar events â€¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="At my day job we deal with enterprise customers. They pay us a subscription fee, and in return we help them in various ways to reduce their carbon footprint. To keep the boat afloat, we need to make some money. We shouldn&rsquo;t spend more money than we make. So we need to keep track of our revenue and costs. Our gross margin is (revenue - cost) / revenue, where the cost is mostly the salaries of our employees."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src=https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ãƒ„</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>Scraping Google Calendar events</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=posts-line-date datetime="2025-10-12 00:00:00 UTC">2025-10-12
</time><span class=posts-line-tag>python</span>
<span class=posts-line-tag>scraping</span></div></div></header><div class="post-content markdown-body"><p>At my day job we deal with enterprise customers. They pay us a subscription fee, and in return we help them in various ways to reduce their carbon footprint. To keep the boat afloat, we need to make some money. We shouldn&rsquo;t spend more money than we make. So we need to keep track of our revenue and costs. Our gross margin is <code>(revenue - cost) / revenue</code>, where the cost is mostly the salaries of our employees.</p><p>We want to track our gross margin on a weekly basis, per customer. We need automation in order to do that. Time tracking is a pain, but one part which is quite objective is the time spent in meetings. All our events are in Google Calendar, so I figured it should be possible to count the hours spent in meetings per customer, and tally that up on a weekly basis.</p><p>Turns out, I didn&rsquo;t find a ready-made solution for that. We use Fivetran at Carbonfact, but their connector only appears to be able to scrape the calendar of the Fivetran users, not of other users in the same Google Suite domain. So I wrote my own script to scrape the calendars of all our employees, and store the events in BigQuery. I rather dislike the fact this is a custom script that we have to maintain ourselves. But <em>c&rsquo;est la vie</em>.</p><p>A few things about the script:</p><ul><li>I used <a href=https://google-calendar-simple-api.readthedocs.io/en/latest/#>Google Calendar Simple API (<code>gsca</code>)</a> &ndash; it&rsquo;s excellent and avoids dealing with the Google API client library directly.</li><li>There are two service accounts involved:<ul><li>One for accessing the Google Calendar API. This one needs to have <a href="https://support.google.com/a/answer/162106?hl=en">domain-wide delegation</a> enabled and the necessary scopes granted by a G Suite admin. The credentials are read from the <code>GOOGLE_CALENDAR_SERVICE_ACCOUNT_JSON</code> environment variable.</li><li>One for writing to BigQuery. This one can be a regular service account with the <code>BigQuery Data Editor</code> role. The script uses Application Default Credentials (ADC), which means essentially you have to be logged in with <code>gcloud auth application-default login</code>, or set the <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable to point to a service account key file.</li></ul></li><li>The email addresses of the employees whose calendars should be scraped are hardcoded in the <code>EMAIL_ACCOUNTS</code> list. Not everyone at my company meets with customers, so I only have to include those who do.</li><li>Calendar events are uploaded to BigQuery at the end of the script. This can easily be customized.</li><li>There is one row per event, identified by its event ID. Meeting attendees are stored as a repeated field (array of structs).</li><li>This script is intended to be run daily. It checks the last event in BigQuery and only scrapes events since then. You can also provide a <code>--since YYYY-MM-DD</code> argument to override this.</li><li>Events are scraped concurrently within a day, but days are processed sequentially. This is to avoid hitting Google API rate limits.</li><li>There&rsquo;s exponential backoff and retrying when scraping events for a user fails.</li><li>The important line of code is <code>GOOGLE_CALENDAR_CREDENTIALS.with_subject(email_account)</code> &ndash; this is what allows the service account with domain-wide delegation to impersonate other users in the domain.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dataclasses</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>datetime</span> <span class=k>as</span> <span class=nn>dt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>concurrent.futures</span> <span class=kn>import</span> <span class=n>ThreadPoolExecutor</span><span class=p>,</span> <span class=n>as_completed</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dotenv</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas_gbq</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tenacity</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>gcsa.google_calendar</span> <span class=kn>import</span> <span class=n>GoogleCalendar</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>google.oauth2</span> <span class=kn>import</span> <span class=n>service_account</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dotenv</span><span class=o>.</span><span class=n>load_dotenv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>EMAIL_ACCOUNTS</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;max@carbonfact.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;felix@carbonfact.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;alexis@carbonfact.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;juliette@carbonfact.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;aditya@carbonfact.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>WRITE_PROJECT_ID</span> <span class=o>=</span> <span class=s2>&#34;google-calendar-import&#34;</span>
</span></span><span class=line><span class=cl><span class=n>WRITE_TABLE_ID</span> <span class=o>=</span> <span class=s2>&#34;google_calendar_import.google_calendar&#34;</span>
</span></span><span class=line><span class=cl><span class=n>WRITE_PROJECT_LOCATION</span> <span class=o>=</span> <span class=s2>&#34;EU&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Read service account credentials from environment variable</span>
</span></span><span class=line><span class=cl><span class=n>service_account_json</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;GCAL_SERVICE_ACCOUNT_JSON&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This will return a Credentials object and the project ID (if available)</span>
</span></span><span class=line><span class=cl><span class=c1># CREDENTIALS, project_id = google.auth.default(scopes=SCOPES)</span>
</span></span><span class=line><span class=cl><span class=n>GOOGLE_CALENDAR_CREDENTIALS</span> <span class=o>=</span> <span class=n>service_account</span><span class=o>.</span><span class=n>Credentials</span><span class=o>.</span><span class=n>from_service_account_info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>service_account_json</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>scopes</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;https://www.googleapis.com/auth/calendar.readonly&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># We don&#39;t provide credentials because we want to fall back to ADC. Meanwhile the</span>
</span></span><span class=line><span class=cl><span class=c1># CREDENTIALS variable is used for accessing the Google Calendar API.</span>
</span></span><span class=line><span class=cl><span class=n>BIQ_QUERY_CREDENTIALS</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>determine_since_when_search</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>dt</span><span class=o>.</span><span class=n>date</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>last_event</span> <span class=o>=</span> <span class=n>pandas_gbq</span><span class=o>.</span><span class=n>read_gbq</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        SELECT *
</span></span></span><span class=line><span class=cl><span class=s2>        FROM </span><span class=si>{</span><span class=n>WRITE_TABLE_ID</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        ORDER BY start_at DESC
</span></span></span><span class=line><span class=cl><span class=s2>        LIMIT 1
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>project_id</span><span class=o>=</span><span class=n>WRITE_PROJECT_ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>location</span><span class=o>=</span><span class=n>WRITE_PROJECT_LOCATION</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>credentials</span><span class=o>=</span><span class=n>BIQ_QUERY_CREDENTIALS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>since</span> <span class=o>=</span> <span class=n>last_event</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>start_at</span><span class=o>.</span><span class=n>date</span><span class=p>()</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>since</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclasses.dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Attendee</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>response_status</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclasses.dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>event_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>attendees</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>Attendee</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>start_at</span><span class=p>:</span> <span class=n>dt</span><span class=o>.</span><span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>end_at</span><span class=p>:</span> <span class=n>dt</span><span class=o>.</span><span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>timezone</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>list_events</span><span class=p>(</span><span class=n>email_account</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>date</span><span class=p>:</span> <span class=n>dt</span><span class=o>.</span><span class=n>date</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>[</span><span class=n>Event</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>delegated_credentials</span> <span class=o>=</span> <span class=n>GOOGLE_CALENDAR_CREDENTIALS</span><span class=o>.</span><span class=n>with_subject</span><span class=p>(</span><span class=n>email_account</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>calendar</span> <span class=o>=</span> <span class=n>GoogleCalendar</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>email_account</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>credentials</span><span class=o>=</span><span class=n>delegated_credentials</span><span class=p>,</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>        <span class=n>read_only</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>calendar</span><span class=o>.</span><span class=n>get_events</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>time_min</span><span class=o>=</span><span class=n>date</span><span class=p>,</span> <span class=n>time_max</span><span class=o>=</span><span class=n>date</span> <span class=o>+</span> <span class=n>dt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span> <span class=n>single_events</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>event</span><span class=o>.</span><span class=n>attendees</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Skip full-day events</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>start</span><span class=p>)</span> <span class=ow>is</span> <span class=n>dt</span><span class=o>.</span><span class=n>date</span> <span class=ow>and</span> <span class=nb>type</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>end</span><span class=p>)</span> <span class=ow>is</span> <span class=n>dt</span><span class=o>.</span><span class=n>date</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Some recurring events slip through the (time_min, time_max) filter. We could do</span>
</span></span><span class=line><span class=cl>        <span class=c1># event.start.date() != date, but that would be a bit too strict with regard to timezones.</span>
</span></span><span class=line><span class=cl>        <span class=c1># So we check that the event is not outside a Â±1 day window. In any case, we can always</span>
</span></span><span class=line><span class=cl>        <span class=c1># deduplicate events by ID later!</span>
</span></span><span class=line><span class=cl>        <span class=n>event_start_date</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>start</span><span class=o>.</span><span class=n>date</span><span class=p>()</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>start</span><span class=p>,</span> <span class=n>dt</span><span class=o>.</span><span class=n>datetime</span><span class=p>)</span> <span class=k>else</span> <span class=n>event</span><span class=o>.</span><span class=n>start</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>event_end_date</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>end</span><span class=o>.</span><span class=n>date</span><span class=p>()</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>end</span><span class=p>,</span> <span class=n>dt</span><span class=o>.</span><span class=n>datetime</span><span class=p>)</span> <span class=k>else</span> <span class=n>event</span><span class=o>.</span><span class=n>end</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>event_start_date</span> <span class=o>&gt;</span> <span class=n>date</span> <span class=o>+</span> <span class=n>dt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=ow>or</span> <span class=n>event_end_date</span> <span class=o>&lt;</span> <span class=n>date</span> <span class=o>-</span> <span class=n>dt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>        <span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Event</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>event_id</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>                <span class=n>title</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>summary</span><span class=p>,</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>                <span class=n>attendees</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>Attendee</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>attendee</span><span class=o>.</span><span class=n>email</span><span class=p>,</span> <span class=n>response_status</span><span class=o>=</span><span class=n>attendee</span><span class=o>.</span><span class=n>response_status</span><span class=p>)</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>attendee</span> <span class=ow>in</span> <span class=n>event</span><span class=o>.</span><span class=n>attendees</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>start_at</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>start</span><span class=p>,</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>                <span class=n>end_at</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>end</span><span class=p>,</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>                <span class=n>timezone</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>timezone</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>events</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tenacity.retry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=o>=</span><span class=n>tenacity</span><span class=o>.</span><span class=n>wait_exponential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>multiplier</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nb>min</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nb>max</span><span class=o>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>  <span class=c1># exponential backoff: 2s, 4s, 8s...</span>
</span></span><span class=line><span class=cl>    <span class=n>stop</span><span class=o>=</span><span class=n>tenacity</span><span class=o>.</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>5</span><span class=p>),</span>  <span class=c1># try up to 5 times</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_list_events</span><span class=p>(</span><span class=n>email</span><span class=p>,</span> <span class=n>day</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>list_events</span><span class=p>(</span><span class=n>email</span><span class=p>,</span> <span class=n>day</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>wrapped_list_events</span><span class=p>(</span><span class=n>email</span><span class=p>,</span> <span class=n>day</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>email</span><span class=p>,</span> <span class=n>day</span><span class=p>,</span> <span class=n>safe_list_events</span><span class=p>(</span><span class=n>email</span><span class=p>,</span> <span class=n>day</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_events_for_day</span><span class=p>(</span><span class=n>day</span><span class=p>:</span> <span class=n>dt</span><span class=o>.</span><span class=n>date</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Event</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>executor</span> <span class=o>=</span> <span class=n>ThreadPoolExecutor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>futures</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>email_account</span> <span class=ow>in</span> <span class=n>EMAIL_ACCOUNTS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>futures</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=n>wrapped_list_events</span><span class=p>,</span> <span class=n>email_account</span><span class=p>,</span> <span class=n>day</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>day_events</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>future</span> <span class=ow>in</span> <span class=n>as_completed</span><span class=p>(</span><span class=n>futures</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>email_account</span><span class=p>,</span> <span class=n>day</span><span class=p>,</span> <span class=n>events</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>day</span><span class=si>}</span><span class=s2> ~ </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>events</span><span class=p>)</span><span class=si>:</span><span class=s2>,d</span><span class=si>}</span><span class=s2> event(s) for </span><span class=si>{</span><span class=n>email_account</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;* </span><span class=si>{</span><span class=n>event</span><span class=o>.</span><span class=n>title</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>event</span><span class=o>.</span><span class=n>start_at</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%H:%M&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>event</span><span class=o>.</span><span class=n>end_at</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%H:%M&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>day_events</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>event_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>event</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>day_events</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>(</span><span class=n>since_date</span><span class=p>:</span> <span class=n>dt</span><span class=o>.</span><span class=n>date</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Determine since when to collect events</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>since_date</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>since</span> <span class=o>=</span> <span class=n>since_date</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>since</span> <span class=o>=</span> <span class=n>determine_since_when_search</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Collecting events since </span><span class=si>{</span><span class=n>since</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Collect new events</span>
</span></span><span class=line><span class=cl>    <span class=n>new_events</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>day</span> <span class=o>=</span> <span class=n>since</span>
</span></span><span class=line><span class=cl>    <span class=n>today</span> <span class=o>=</span> <span class=n>dt</span><span class=o>.</span><span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>day</span> <span class=o>&lt;=</span> <span class=n>today</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>day_events</span> <span class=o>=</span> <span class=n>get_events_for_day</span><span class=p>(</span><span class=n>day</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>day</span><span class=si>}</span><span class=s2> ~ </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>day_events</span><span class=p>)</span><span class=si>:</span><span class=s2>,d</span><span class=si>}</span><span class=s2> event(s) in total&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>new_events</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>day_events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>day</span> <span class=o>+=</span> <span class=n>dt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Write new events to BigQuery</span>
</span></span><span class=line><span class=cl>    <span class=n>new_events_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=o>.</span><span class=n>from_records</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=o>**</span><span class=n>dataclasses</span><span class=o>.</span><span class=n>asdict</span><span class=p>(</span><span class=n>event</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;attendees&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>dataclasses</span><span class=o>.</span><span class=n>asdict</span><span class=p>(</span><span class=n>attendee</span><span class=p>)</span> <span class=k>for</span> <span class=n>attendee</span> <span class=ow>in</span> <span class=n>event</span><span class=o>.</span><span class=n>attendees</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>new_events</span><span class=o>.</span><span class=n>values</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pandas_gbq</span><span class=o>.</span><span class=n>to_gbq</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>new_events_df</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>WRITE_TABLE_ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>project_id</span><span class=o>=</span><span class=n>WRITE_PROJECT_ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>location</span><span class=o>=</span><span class=n>WRITE_PROJECT_LOCATION</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>if_exists</span><span class=o>=</span><span class=s2>&#34;append&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>credentials</span><span class=o>=</span><span class=n>BIQ_QUERY_CREDENTIALS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Scrape and store Google Calendar events&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--since&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=n>dt</span><span class=o>.</span><span class=n>date</span><span class=o>.</span><span class=n>fromisoformat</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Start date for event collection in YYYY-MM-DD format. If not provided, will use determine_since_when_search()&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>format</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>%(asctime)s</span><span class=s2> - </span><span class=si>%(name)s</span><span class=s2> - </span><span class=si>%(levelname)s</span><span class=s2> - </span><span class=si>%(message)s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s2>&#34;googleapiclient.discovery_cache&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>ERROR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>since</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Google Calendar scraping completed âœ…&#34;</span><span class=p>)</span>
</span></span></code></pre></div></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>
Back to the top</div></div><div class=subscribe><a href=http://eepurl.com/iRBqMg>Subscribe</a></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/blog/lca-exit-the-matrix/>LCA software: exit the matrix</a></li><li><a href=/blog/carbon-footprint-pizzas/>Measuring the carbon footprint of pizzas</a></li><li><a href=/blog/sympy-doctests/>Using SymPy in Python doctests</a></li></ul></div></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll("img"));images.forEach(e=>{mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null})})</script></body></html>