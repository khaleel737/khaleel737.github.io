<!doctype html><html lang=en><head><script defer src=https://analytics.eu.umami.is/script.js data-website-id=ff740bb2-f741-4bc5-975e-49691d82ef39></script><meta charset=utf-8><meta name=generator content="Hugo 0.151.0"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://maxhalford.github.io/blog/metric-tree-total-derivative/"><link rel=canonical href=https://maxhalford.github.io/blog/metric-tree-total-derivative/><meta property="og:url" content="https://maxhalford.github.io/blog/metric-tree-total-derivative/"><meta property="og:site_name" content="Max Halford"><meta property="og:title" content="The total derivative of a metric tree"><meta property="og:description" content="A metric tree is a visual way to organize a complex metric. Count gives a good introduction here. Abhi Sivasailam gave a popular talk at Data Council 2023 if watching videos is your thing. Ergest Xheblati is someone to follow if you want to go deeper. Thereâ€™s also a recent article from Lightdash. Finally, thereâ€™s this article by Timo Dechau, but itâ€™s behind a paywall. The concept has a homonym, so beware when you browse for it."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-05-06T00:00:00+00:00"><meta property="article:modified_time" content="2025-05-06T00:00:00+00:00"><meta property="article:tag" content="Data-Science"><meta property="og:image" content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:title content="The total derivative of a metric tree"><meta name=twitter:description content="A metric tree is a visual way to organize a complex metric. Count gives a good introduction here. Abhi Sivasailam gave a popular talk at Data Council 2023 if watching videos is your thing. Ergest Xheblati is someone to follow if you want to go deeper. Thereâ€™s also a recent article from Lightdash. Finally, thereâ€™s this article by Timo Dechau, but itâ€™s behind a paywall. The concept has a homonym, so beware when you browse for it."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦”</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"The total derivative of a metric tree","headline":"The total derivative of a metric tree","description":"\u003cp\u003e\u003cem\u003eA metric tree is a visual way to organize a complex metric. Count gives a good introduction \u003ca href=\u0022https:\/\/count.co\/blog\/intro-to-metric-trees\u0022\u003ehere\u003c\/a\u003e. \u003ca href=\u0022https:\/\/www.linkedin.com\/in\/abhi-sivasailam\/\u0022\u003eAbhi Sivasailam\u003c\/a\u003e gave a popular \u003ca href=\u0022https:\/\/www.youtube.com\/watch?v=Dbr8jmtfZ7Q\u0026amp;ab_channel=DataCouncil\u0022\u003etalk\u003c\/a\u003e at Data Council 2023 if watching videos is your thing. \u003ca href=\u0022https:\/\/www.linkedin.com\/in\/ergestx\/\u0022\u003eErgest Xheblati\u003c\/a\u003e is someone to follow if you want to go deeper. There\u0026rsquo;s also a \u003ca href=\u0022https:\/\/www.lightdash.com\/blogpost\/metric-trees-how-top-data-teams-impact-growth\u0022\u003erecent article\u003c\/a\u003e from Lightdash. Finally, there\u0026rsquo;s \u003ca href=\u0022https:\/\/timodechau.com\/metric-trees-for-digital-analysts\/\u0022\u003ethis article\u003c\/a\u003e by Timo Dechau, but it\u0026rsquo;s behind a paywall. The concept has a \u003ca href=\u0022https:\/\/en.wikipedia.org\/wiki\/Metric_tree\u0022\u003ehomonym\u003c\/a\u003e, so beware when you browse for it.\u003c\/em\u003e\u003c\/p\u003e","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2025","datePublished":"2025-05-06 00:00:00 \u002b0000 UTC","dateModified":"2025-05-06 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/metric-tree-total-derivative\/","keywords":["data-science"]}</script><title>The total derivative of a metric tree â€¢ Max Halford</title><meta property="og:title" content="The total derivative of a metric tree â€¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="A metric tree is a visual way to organize a complex metric. Count gives a good introduction here. Abhi Sivasailam gave a popular talk at Data Council 2023 if watching videos is your thing. Ergest Xheblati is someone to follow if you want to go deeper. There&rsquo;s also a recent article from Lightdash. Finally, there&rsquo;s this article by Timo Dechau, but it&rsquo;s behind a paywall. The concept has a homonym, so beware when you browse for it."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src=https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ãƒ„</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>The total derivative of a metric tree</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=posts-line-date datetime="2025-05-06 00:00:00 UTC">2025-05-06
</time><span class=posts-line-tag>data-science</span></div></div></header><div class="post-content markdown-body"><h2 id=toc>Table of contents</h2><nav id=TableOfContents></nav><p><em>A metric tree is a visual way to organize a complex metric. Count gives a good introduction <a href=https://count.co/blog/intro-to-metric-trees>here</a>. <a href=https://www.linkedin.com/in/abhi-sivasailam/>Abhi Sivasailam</a> gave a popular <a href="https://www.youtube.com/watch?v=Dbr8jmtfZ7Q&amp;ab_channel=DataCouncil">talk</a> at Data Council 2023 if watching videos is your thing. <a href=https://www.linkedin.com/in/ergestx/>Ergest Xheblati</a> is someone to follow if you want to go deeper. There&rsquo;s also a <a href=https://www.lightdash.com/blogpost/metric-trees-how-top-data-teams-impact-growth>recent article</a> from Lightdash. Finally, there&rsquo;s <a href=https://timodechau.com/metric-trees-for-digital-analysts/>this article</a> by Timo Dechau, but it&rsquo;s behind a paywall. The concept has a <a href=https://en.wikipedia.org/wiki/Metric_tree>homonym</a>, so beware when you browse for it.</em></p><p>Many companies build metric trees without even knowing it. For instance, at Carbonfact, we have a health score to keep track of the state of each one of our customers. It&rsquo;s a weighted average of three inputs &ndash; denoted $x$, $y$, and $z$ in the diagram below.</p><div align=center><pre class=mermaid>
    flowchart LR
    A1[&#34;$$0.2 \times x$$&#34;] --&gt; SUM
    A2[&#34;$$0.3 \times y$$&#34;] --&gt; SUM
    A3[&#34;$$0.5 \times z$$&#34;] --&gt; SUM
    SUM(&#34;$$+$$&#34;) --&gt; Score[&#34;$$\verb|score|$$&#34;]
  </pre></div><p>Our health score is just a linear combination of three metrics. We can think of it as a metric tree with one level of depth. We don&rsquo;t really care about that, though. We just compute it via a SQL query, which looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>x</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(...),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>y</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(...),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>z</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(...)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>0</span><span class=p>.</span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>x</span><span class=p>.</span><span class=n>value</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>0</span><span class=p>.</span><span class=mi>3</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>y</span><span class=p>.</span><span class=n>value</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>0</span><span class=p>.</span><span class=mi>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>z</span><span class=p>.</span><span class=n>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>health_score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=n>account_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>z</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=n>account_id</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>So what&rsquo;s the point of using a metric tree? Visualization could a reason. But the metric is simple, so a table report is enough. The real reason is that the metric tree highlights the metric&rsquo;s structure. It shows how the metric is built, and how to break it down into its components.</p><p>Whenever you implement a metric at a company, you need to be able to explain it. Someone will eventually ask you <a href=/blog/kpi-evolution-decomposition/>why the metric changed</a> over time. There isn&rsquo;t always a simple answer to that question. It would be convenient if there was though.</p><p>I like the idea that a metric tree is essentially just a function. You can think of it as a multivariate function that takes a set of inputs and returns a single output. There may be intermediate outputs, depending on the metric&rsquo;s complexity. The metric tree is just a way to visualize the function&rsquo;s structure.</p><p>Any well-defined function can be differentiated &ndash; i.e. provided it is <a href="https://en.wikipedia.org/wiki/Differentiable_function#:~:text=A%20function%20is%20said%20to%20be%20continuously%20differentiable%20if%20the,to%20have%20an%20essential%20discontinuity.">continuously differentiable</a>. In particular, the <a href=https://en.wikipedia.org/wiki/Total_derivative>total derivative</a> gives us a way to understand the change in the output with respect to each input. It is a linear approximation of the function at a given point.</p><p>$$
\frac{d f}{d t} = \sum_{i=1}^n \frac{\partial f}{\partial x_i} \frac{d x_i}{d t}
$$</p><p>You&rsquo;d be right to find this a bit dumb, because it&rsquo;s Math 101. However, I haven&rsquo;t seen it used in the context of metric trees, or any kind of analytics engineering for that matter:</p><p>$$
f(x_{1}^{t+1}, \dots, x_{n}^{t+1}) - f(x_{1}^{t}, \dots, x_{n}^{t}) = \sum_{i=1}^n \frac{\partial f}{\partial x_i} \times (x_i^{t+1} - x_i^{t})
$$</p><p>I thought it would be interesting to try it out. I have some anonymized data from Carbonfact that I can use to illustrate the idea:</p><table><thead><tr><th style=text-align:left>account</th><th style=text-align:left>week</th><th style=text-align:right>$x$</th><th style=text-align:right>$y$</th><th style=text-align:right>$z$</th><th style=text-align:right>$w$</th></tr></thead><tbody><tr><td style=text-align:left>A</td><td style=text-align:left>2025-04-20</td><td style=text-align:right>3</td><td style=text-align:right>0</td><td style=text-align:right>5</td><td style=text-align:right>0.28</td></tr><tr><td style=text-align:left>A</td><td style=text-align:left>2025-04-13</td><td style=text-align:right>5</td><td style=text-align:right>3</td><td style=text-align:right>5</td><td style=text-align:right>0.28</td></tr><tr><td style=text-align:left>B</td><td style=text-align:left>2025-04-20</td><td style=text-align:right>5</td><td style=text-align:right>3</td><td style=text-align:right>3</td><td style=text-align:right>0.55</td></tr><tr><td style=text-align:left>B</td><td style=text-align:left>2025-04-13</td><td style=text-align:right>5</td><td style=text-align:right>5</td><td style=text-align:right>3</td><td style=text-align:right>0.55</td></tr><tr><td style=text-align:left>C</td><td style=text-align:left>2025-04-20</td><td style=text-align:right>5</td><td style=text-align:right>5</td><td style=text-align:right>0</td><td style=text-align:right>0.17</td></tr><tr><td style=text-align:left>C</td><td style=text-align:left>2025-04-13</td><td style=text-align:right>5</td><td style=text-align:right>0</td><td style=text-align:right>0</td><td style=text-align:right>0.17</td></tr></tbody></table><ul><li>There&rsquo;s three accounts: A, B, and C.</li><li>Each account has two weeks of data: 2025-04-13 and 2025-04-20.</li><li>Each week has three metrics: $x$, $y$, and $z$.</li><li>There&rsquo;s also a $w$ column, which is weighting factor, but we&rsquo;ll leave it for later.</li></ul><p>We can calculate the health score for each account and week. But the interesting part is being able to explain the change in the health score between two weeks, with respect to each input. We can do this by applying the total derivative method.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sympy</span> <span class=k>as</span> <span class=nn>sp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define metric tree (just a simple linear combination here)</span>
</span></span><span class=line><span class=cl><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span> <span class=o>=</span> <span class=n>sp</span><span class=o>.</span><span class=n>symbols</span><span class=p>(</span><span class=s1>&#39;x y z&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>variables</span> <span class=o>=</span> <span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=nb>str</span><span class=p>(</span><span class=n>y</span><span class=p>),</span> <span class=nb>str</span><span class=p>(</span><span class=n>z</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>health_score_func</span> <span class=o>=</span> <span class=mf>0.2</span> <span class=o>*</span> <span class=n>x</span> <span class=o>+</span> <span class=mf>0.3</span> <span class=o>*</span> <span class=n>y</span> <span class=o>+</span> <span class=mf>0.5</span> <span class=o>*</span> <span class=n>z</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate gradient w.r.t. each input</span>
</span></span><span class=line><span class=cl><span class=n>gradient</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>var</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>health_score_func</span><span class=p>,</span> <span class=n>var</span><span class=p>)</span> <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>variables</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>variables</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>account</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Calculate health score before and after</span>
</span></span><span class=line><span class=cl>    <span class=n>T0</span> <span class=o>=</span> <span class=n>scores</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>&#39;account == @account&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>T1</span> <span class=o>=</span> <span class=n>scores</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>&#39;account == @account&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>observed_diff</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>health_score_func</span><span class=o>.</span><span class=n>subs</span><span class=p>({</span><span class=n>var</span><span class=p>:</span> <span class=n>T1</span><span class=p>[</span><span class=n>var</span><span class=p>]</span> <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>variables</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=o>-</span> <span class=n>health_score_func</span><span class=o>.</span><span class=n>subs</span><span class=p>({</span><span class=n>var</span><span class=p>:</span> <span class=n>T0</span><span class=p>[</span><span class=n>var</span><span class=p>]</span> <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>variables</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Apply total derivative method</span>
</span></span><span class=line><span class=cl>    <span class=n>diff_breakdown</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var</span><span class=p>:</span> <span class=n>gradient</span><span class=p>[</span><span class=n>var</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=n>T1</span><span class=p>[</span><span class=n>var</span><span class=p>]</span> <span class=o>-</span> <span class=n>T0</span><span class=p>[</span><span class=n>var</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>variables</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>total_diff</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>diff_breakdown</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Print results</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>account</span><span class=si>=}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;===========&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>observed_diff</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> : observed_diff&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>total_diff</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> : total_diff&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;~~~~~~~~~~~&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>var</span><span class=p>,</span> <span class=n>diff</span> <span class=ow>in</span> <span class=n>diff_breakdown</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>diff</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> : diff(</span><span class=si>{</span><span class=n>var</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>account=&#39;A&#39;
</span></span><span class=line><span class=cl><span class=gh>===========
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>-1.3 : observed_diff
</span></span></span><span class=line><span class=cl><span class=gd>-1.3 : total_diff
</span></span></span><span class=line><span class=cl><span class=gd></span>~~~~~~~~~~~
</span></span><span class=line><span class=cl><span class=gd>-0.4 : diff(x)
</span></span></span><span class=line><span class=cl><span class=gd>-0.9 : diff(y)
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gh>=0.0 : diff(z)
</span></span></span><span class=line><span class=cl><span class=gh></span>
</span></span><span class=line><span class=cl>account=&#39;B&#39;
</span></span><span class=line><span class=cl><span class=gh>===========
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>-0.6 : observed_diff
</span></span></span><span class=line><span class=cl><span class=gd>-0.6 : total_diff
</span></span></span><span class=line><span class=cl><span class=gd></span>~~~~~~~~~~~
</span></span><span class=line><span class=cl><span class=gh>=0.0 : diff(x)
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>-0.6 : diff(y)
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gh>=0.0 : diff(z)
</span></span></span><span class=line><span class=cl><span class=gh></span>
</span></span><span class=line><span class=cl>account=&#39;C&#39;
</span></span><span class=line><span class=cl><span class=gh>===========
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gi>+1.5 : observed_diff
</span></span></span><span class=line><span class=cl><span class=gi>+1.5 : total_diff
</span></span></span><span class=line><span class=cl><span class=gi></span>~~~~~~~~~~~
</span></span><span class=line><span class=cl><span class=gh>=0.0 : diff(x)
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gi>+1.5 : diff(y)
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gh>=0.0 : diff(z)
</span></span></span></code></pre></div><p>It works!</p><ul><li><code>observed_diff</code> corresponds to $f(x_{1}^{t+1}, \dots, x_{n}^{t+1}) - f(x_{1}^{t}, \dots, x_{n}^{t})$</li><li><code>diff(x)</code> corresponds to $\frac{\partial f}{\partial x}\times (x_1^{t+1} - x_1^{t})$</li><li><code>diff(y)</code> corresponds to $\frac{\partial f}{\partial x}\times (x_2^{t+1} - x_2^{t})$</li><li><code>diff(z)</code> corresponds to $\frac{\partial f}{\partial x}\times (x_3^{t+1} - x_3^{t})$</li><li><code>total_diff = diff(x) + diff(y) + diff(z)</code> corresponds to the sum of all the partial derivatives</li></ul><p>The total derivative method provides a way to explain the change in the health score with respect to each input. We can see how much each input contributed to the change in the health score. We know it is valid because summing up the partial derivatives matches the observed difference between $t$ and $t+1$.</p><p>What I particularly like about this method is its universal applicability. It should work for any metric tree. For instance, let&rsquo;s say that we wish to calculate a weighted average of the customer health score, by weighting each account by its $w$ value. At Carbonfact $w$ corresponds to the customer&rsquo;s importance.</p><pre class=mermaid>
    flowchart LR
    A1[&#34;$$0.2 \times x$$&#34;] --&gt; ASUM
    A2[&#34;$$0.3 \times y$$&#34;] --&gt; ASUM
    A3[&#34;$$0.5 \times z$$&#34;] --&gt; ASUM
    ASUM(&#34;$$+$$&#34;) --&gt; AScore[&#34;$$0.28 \times \verb|A|$$&#34;]

    B1[&#34;$$0.2 \times x$$&#34;] --&gt; BSUM
    B2[&#34;$$0.3 \times y$$&#34;] --&gt; BSUM
    B3[&#34;$$0.5 \times z$$&#34;] --&gt; BSUM
    BSUM(&#34;$$+$$&#34;) --&gt; BScore[&#34;$$0.55 \times \verb|B|$$&#34;]

    C1[&#34;$$0.2 \times x$$&#34;] --&gt; CSUM
    C2[&#34;$$0.3 \times y$$&#34;] --&gt; CSUM
    C3[&#34;$$0.5 \times z$$&#34;] --&gt; CSUM
    CSUM(&#34;$$+$$&#34;) --&gt; CScore[&#34;$$0.17 \times \verb|C|$$&#34;]

    AScore --&gt; SUM(&#34;$$+$$&#34;)
    BScore --&gt; SUM(&#34;$$+$$&#34;)
    CScore --&gt; SUM(&#34;$$+$$&#34;)
    SUM --&gt; Score[&#34;$$\verb|score|$$&#34;]
  </pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sympy</span> <span class=k>as</span> <span class=nn>sp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define metric tree (just a simple linear combination here)</span>
</span></span><span class=line><span class=cl><span class=n>symbols</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>account</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>symbols</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>account</span><span class=si>}</span><span class=s1>[</span><span class=si>{</span><span class=n>var</span><span class=si>}</span><span class=s1>]&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=s1>&#39;z&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>account</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>total_health_score_func</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=mf>0.2</span> <span class=o>*</span> <span class=n>variables</span><span class=p>[</span><span class=s1>&#39;x&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=mf>0.3</span> <span class=o>*</span> <span class=n>variables</span><span class=p>[</span><span class=s1>&#39;y&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=mf>0.5</span> <span class=o>*</span> <span class=n>variables</span><span class=p>[</span><span class=s1>&#39;z&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>variables</span> <span class=ow>in</span> <span class=n>symbols</span><span class=o>.</span><span class=n>values</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate gradient w.r.t. each input</span>
</span></span><span class=line><span class=cl><span class=n>gradient</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>account</span><span class=p>),</span> <span class=n>var</span><span class=p>):</span> <span class=n>sp</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>total_health_score_func</span><span class=p>,</span> <span class=n>variables</span><span class=p>[</span><span class=n>var</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>account</span><span class=p>,</span> <span class=n>variables</span> <span class=ow>in</span> <span class=n>symbols</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>variables</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate health score before and after</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_health_score</span><span class=p>(</span><span class=n>accounts</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>sum</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>account</span><span class=p>[</span><span class=s1>&#39;w&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>health_score_func</span><span class=o>.</span><span class=n>subs</span><span class=p>({</span><span class=n>var</span><span class=p>:</span> <span class=n>account</span><span class=p>[</span><span class=n>var</span><span class=p>]</span> <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>variables</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>account</span> <span class=ow>in</span> <span class=n>accounts</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(</span><span class=n>orient</span><span class=o>=</span><span class=s1>&#39;records&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>T0</span> <span class=o>=</span> <span class=n>scores</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>&#39;week == &#34;2025-04-13&#34;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>T1</span> <span class=o>=</span> <span class=n>scores</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>&#39;week == &#34;2025-04-20&#34;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>observed_diff</span> <span class=o>=</span> <span class=n>calculate_health_score</span><span class=p>(</span><span class=n>T1</span><span class=p>)</span> <span class=o>-</span> <span class=n>calculate_health_score</span><span class=p>(</span><span class=n>T0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Apply total derivative method</span>
</span></span><span class=line><span class=cl><span class=n>diff_breakdown</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>account</span><span class=p>,</span> <span class=n>var</span><span class=p>):</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>gradient</span><span class=p>[</span><span class=n>account</span><span class=p>,</span> <span class=n>var</span><span class=p>]</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>T1</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>&#39;account == @account&#39;</span><span class=p>)[</span><span class=n>var</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=o>-</span> <span class=n>T0</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>&#39;account == @account&#39;</span><span class=p>)[</span><span class=n>var</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>account</span><span class=p>,</span> <span class=n>variables</span> <span class=ow>in</span> <span class=n>symbols</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>variables</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>total_diff</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>diff_breakdown</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Print results</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>observed_diff</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> â€” observed_diff&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>total_diff</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> â€” total_diff&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;~~~~~~~~~~~&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>account</span><span class=p>,</span> <span class=n>var</span><span class=p>),</span> <span class=n>diff</span> <span class=ow>in</span> <span class=n>diff_breakdown</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>diff</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> : diff(</span><span class=si>{</span><span class=n>account</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>var</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>-0.4 : observed_diff
</span></span></span><span class=line><span class=cl><span class=gd>-0.4 : total_diff
</span></span></span><span class=line><span class=cl><span class=gd></span>~~~~~~~~~~~
</span></span><span class=line><span class=cl><span class=gd>-0.4 : diff(A, x)
</span></span></span><span class=line><span class=cl><span class=gd>-0.9 : diff(A, y)
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gh>=0.0 : diff(A, z)
</span></span></span><span class=line><span class=cl><span class=gh>=0.0 : diff(B, x)
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>-0.6 : diff(B, y)
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gh>=0.0 : diff(B, z)
</span></span></span><span class=line><span class=cl><span class=gh>=0.0 : diff(C, x)
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gi>+1.5 : diff(C, y)
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gh>=0.0 : diff(C, z)
</span></span></span></code></pre></div><p>The overall total health score is a function of 9 inputs: $x$, $y$, and $z$ for each account. The total derivative method still works. We can see how much each input within each account contributed to the change in the total health score.</p><p>The cool thing is that we can also differentiate with respect to each account. Indeed, it&rsquo;s useful to know the contribution of each account to the total health score, without necessarily drilling down to each input within each account.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sympy</span> <span class=k>as</span> <span class=nn>sp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define metric tree (just a simple linear combination here)</span>
</span></span><span class=line><span class=cl><span class=n>symbols</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>account</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>symbols</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>account</span><span class=si>}</span><span class=s1>[</span><span class=si>{</span><span class=n>var</span><span class=si>}</span><span class=s1>]&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=s1>&#39;z&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>account</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>account_health_scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>account</span><span class=p>,</span> <span class=n>variables</span> <span class=ow>in</span> <span class=n>symbols</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>account_symbol</span> <span class=o>=</span> <span class=n>sp</span><span class=o>.</span><span class=n>symbols</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>account</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>account_health_scores</span><span class=p>[</span><span class=n>account_symbol</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.2</span> <span class=o>*</span> <span class=n>variables</span><span class=p>[</span><span class=s1>&#39;x&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=mf>0.3</span> <span class=o>*</span> <span class=n>variables</span><span class=p>[</span><span class=s1>&#39;y&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=mf>0.5</span> <span class=o>*</span> <span class=n>variables</span><span class=p>[</span><span class=s1>&#39;z&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>total_health_score_func</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>account_health_scores</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate gradient w.r.t. each account</span>
</span></span><span class=line><span class=cl><span class=n>gradient</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>str</span><span class=p>(</span><span class=n>account</span><span class=p>):</span> <span class=n>sp</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>total_health_score_func</span><span class=p>,</span> <span class=n>account</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>account</span> <span class=ow>in</span> <span class=n>account_health_scores</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Apply total derivative method</span>
</span></span><span class=line><span class=cl><span class=n>diff_breakdown</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>account</span><span class=p>:</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>gradient</span><span class=p>[</span><span class=n>account</span><span class=p>]</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>calculate_health_score</span><span class=p>(</span><span class=n>T1</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>&#39;account == @account&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-</span> <span class=n>calculate_health_score</span><span class=p>(</span><span class=n>T0</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>&#39;account == @account&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>account</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>total_diff</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>diff_breakdown</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Print results</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>account</span><span class=p>,</span> <span class=n>diff</span> <span class=ow>in</span> <span class=n>diff_breakdown</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>diff</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> : diff(</span><span class=si>{</span><span class=n>account</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>-1.3 : diff(A)
</span></span></span><span class=line><span class=cl><span class=gd>-0.6 : diff(B)
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+1.5 : diff(C)
</span></span></span></code></pre></div><p>I find this very useful. To keep the metric tree metaphor alive, we can think of this as differentiating with respect to the branches, whilst the previous results were differentiating with respect to the leaves. The total derivative method is flexible enough to allow us to do that.</p><p>Anywa, how valid is this method? Well, the total derivative method is a well-established concept in calculus. It doesn&rsquo;t work so well for non-linear functions, when there are discontinuities or sharp jumps. But it works well for linear functions, which should cover a lot of the use cases for metric trees. That being said, it is supposed to be used to study infinitesimal local changes. Ultimately, the total derivative method is part of the larger family of <a href=https://en.wikipedia.org/wiki/Sensitivity_analysis>sensitivity analysis</a>. There may be other valid methods in that family, but I think the total derivative has nice properties that make it a good candidate for differentiating metric trees.</p><p>I have to apologize for the clunkiness of the code. I could have packaged this into something more elegant, but I wanted to keep the lid open on the implementation. I&rsquo;m confident there&rsquo;s a nice way to package this into a friendly API.</p><p>My mind is buzzing with ideas of surfacing this up in a BI tool. I don&rsquo;t think <a href=https://www.metabase.com/>Metabase</a>, <a href=https://www.lightdash.com/>Lightdash</a> or <a href=https://steep.app/>Steep</a> fit the bill, because there&rsquo;s a need to call an <a href=https://en.wikipedia.org/wiki/Automatic_differentiation>automatic differentiation</a> library. I used <a href=https://www.sympy.org/en/index.html>SymPy</a> for the sake of example, but ideally a TypeScript library would be used to embed this in a tool like <a href=https://observablehq.com>Observable</a> or <a href=https://evidence.dev>Evidence</a>. Another option would be to use <a href=https://pyodide.org/en/stable/>Pyodide</a> to run Python in the browser. Also, how does this play with <a href=https://duckdb.org/>DuckDB</a> if we want something quick and interactive? There&rsquo;s a lot to think about ðŸ¦†</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>
Back to the top</div></div><div class=subscribe><a href=http://eepurl.com/iRBqMg>Subscribe</a></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/blog/funnel-decomposition/>Decomposing funnel metrics</a></li><li><a href=/blog/hard-data-integration-problems-at-carbonfact/>Hard data integration problems at Carbonfact</a></li><li><a href=/blog/cutting-up-shoes/>Cutting up shoes to measure their footprint</a></li></ul></div></div></div></article><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll("img"));images.forEach(e=>{mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null})})</script></body></html>